<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title id="title1">Test</title>
	<style>
		* 
		{
			font-family:sans-serif;
			font-size: 14px;		
		}
		
		body
		{
			background: black;
		}
	</style>
</head>
<body>
	<!--<h1 id="title2">CarPDD</h1>
	<div class="divcontainer">
		<div class="divcol">         			
			<h2>DEBUG: CURR DATA</h2>
			<div class="showhide"><a class="showhidebutton"><img class="showimg" /></a></div>
			<div class="divcont">
                <p id="currpostest" style="font-family:courier;">No Data!</p>
            </div>
        </div>
    </div>	 
    <div class="divcontainer">
    <div class="divcol">         			
        <h2>PDD raw</h2>
        <div class="showhide"><a class="showhidebutton"><img class="showimg" /></a></div>
        <div class="divcont hidden">
            <p id="curr" style="font-family:courier;">No Data!</p>
        </div>
    </div>
    </div>	
	<div class="divcontainer">
		<div class="divcol">         			
			<h2>SPEED CTRL</h2>
			<div class="showhide"><a class="showhidebutton"><img class="showimg" /></a></div>
			<div class="divcont hidden">
                <p id="spdlimits" style="font-family:courier;">No Data!</p>
            </div>
        </div>
    </div>
	<div class="divcontainer">
		<div class="divcol">         			
			<h2>PDD</h2>
			<div class="showhide"><a class="showhidebutton"><img class="showimg" /></a></div>
			<div class="divcont">
                <div id="pdd" height="100vh"></div>
            </div>
        </div>
    </div>-->
	<div id="pdd" width="100vw" height="100vh"></div>
    
    <script>
        var lat;
        var lon;
        var alt;
        var hdg;
        var spd;
		var vdelta;
        var acc;
        var dst = 0;
        var datacnt = 0;
        
        var spdlmts = [ 30, 50, 60, 70, 80, 100, 120 ];
        var tolerancespdlmt = 5;
        
		drawPDD("pdd");
		
        getpos();
        
		function drawPDD(targetID)
		{
			var frame = document.getElementById(targetID);
			frame.style.background = "black";
			frame.innerHTML = `<svg width="90vw" height="90vw" viewbox="0 0 300 300" id="svgPDD" style="margin:10px"></svg>`;
			var svgPDD = document.getElementById("svgPDD");
			svgPDD.innerHTML += `<rect x="0" y="20" width="80" height="300" style="stroke:none;fill:gray" />"`;
			svgPDD.innerHTML += `<line x1="0" y1="20" x2="100" y2="20" style="stroke:white;stroke-width:2" />`;
			svgPDD.innerHTML += `<line x1="0" y1="299" x2="100" y2="299" style="stroke:white;stroke-width:2" />`;			
			svgPDD.innerHTML += `<line x1="80" y1="20" x2="80" y2="300" style="stroke:white;stroke-width:2" />`;			
			svgPDD.innerHTML += genSpeedTabObj();
			svgPDD.innerHTML += '<line x1="0" y1="150" x2="90" y2="150" style="stroke:yellow;stroke-width:2" />';
			svgPDD.innerHTML += '<polyline points="85,150 95,145 95,155" style="stroke:none;fill:yellow" />';
			svgPDD.innerHTML += '<rect x="10" y="-200" width="180" height="219" style="stroke:none;fill:black" />';		
			
			svgPDD.innerHTML += `<rect x="220" y="20" width="80" height="300" style="stroke:none;fill:gray" />"`;
			svgPDD.innerHTML += `<line x1="300" y1="20" x2="200" y2="20" style="stroke:white;stroke-width:2" />`;
			svgPDD.innerHTML += `<line x1="300" y1="299" x2="200" y2="299" style="stroke:white;stroke-width:2" />`;			
			svgPDD.innerHTML += `<line x1="220" y1="20" x2="220" y2="300" style="stroke:white;stroke-width:2" />`;			
			svgPDD.innerHTML += genAltTabObj();			
			svgPDD.innerHTML += '<rect x="220" y="0" width="80" height="19" style="stroke:none;fill:black" />';			
			svgPDD.innerHTML += '<rect x="220" y="-200" width="80" height="219" style="stroke:none;fill:black" />';		
			svgPDD.innerHTML += '<rect x="220" y="140" width="80" height="20" style="stroke:yellow;fill:black;stroke-width:2" />';		
			svgPDD.innerHTML += '<text x="235" y="156" style="fill:lime;" id="valAltTab">XXXX</text>';		
			svgPDD.innerHTML += '<rect x="0" y="300" width="500" height="219" style="stroke:none;fill:black" />';	
			
			svgPDD.innerHTML += '<rect x="0" y="0" width="80" height="19" style="stroke:white;fill:black" />';			
			svgPDD.innerHTML += '<text x="5" y="16" fill="magenta" id="valSpdTab">XXX km/h</text>';			
			svgPDD.innerHTML += '<rect x="80" y="0" width="140" height="19" style="stroke:white;fill:black" />';			
			svgPDD.innerHTML += '<text x="105" y="16" fill="magenta" id="valDst">XXXX.XXX km</text>';
			svgPDD.innerHTML += '<rect x="220" y="0" width="80" height="19" style="stroke:white;fill:black" />';			
			svgPDD.innerHTML += '<text x="225" y="16" fill="magenta" id="valHdg">XXX °</text>';
		}
		
		function setHdgCurrV(a)
		{
			document.getElementById("valHdg").innerHTML = a + " °";		
		}
		
		function setDstCurrV(a)
		{
			document.getElementById("valDst").innerHTML = a + " km";		
		}
		
		function genAltTabObj()
		{
			var outElement = "<g id='altTab'>";
			var a;
			for (a = 0; a <= 5000; a += 50)
			{
				y = 300-a;
				outElement += `<line x1="230" y1="${y}" x2="220" y2="${y}" style='stroke:white;stroke-width:2;'/>`;
				outElement += `<text x="260" y="${y+5}" fill="white">${a}</text>`;
			}
			outElement += "</g>";
			
			return outElement;
		}
		
		function setAltTabCurrV(a)
		{
			document.getElementById("valAltTab").innerHTML = a;
			
			v = a;
			v -= 150;
		
			document.getElementById("altTab").setAttribute("transform", `translate(0,${v})`);			
		}
		
		function genSpeedTabObj()
		{
			var outElement = "<g id='spdTab'>";
			var y;
			for (v = 0; v <= 250; v += 10)
			{
				y = 300-4*v;
				outElement += `<line x1="70" y1="${y}" x2="80" y2="${y}" style='stroke:white;stroke-width:2;'/>`;
				outElement += `<text x="40" y="${y+5}" fill="white">${v}</text>`;
			}
			
			var markerV = [ 22, 32, 38, 45, 55 ];
			var markerID = [ "2", "3", "4", "5", "6" ];
			
			for (var i = 0; i < markerV.length; i++)
			{
				y = 300-4*markerV[i];
				outElement += `<line x1="70" y1="${y}" x2="80" y2="${y}" style='stroke:lime;stroke-width:2;'/>`;
				outElement += `<text x="84" y="${y+5}" fill="lime">${markerID[i]}</text>`;
			}
			
			var absLowLimit = 7;
			y = 300 - 4 * absLowLimit; 
			outElement += `<line x1="84" y1="450" x2="84" y2="${y}" style="stroke:orange;stroke-width:2;"/>`;
			
			outElement += "</g>";
			
			return outElement;
		}
		
		function setSpeedTabCurrV(v, vdelta)
		{
			document.getElementById("valSpdTab").innerHTML = v + " km/h";
			
			v = v * 4;
			v -= 150;
		
			document.getElementById("spdTab").setAttribute("transform", `translate(0,${v})`);
			
			if (document.getElementById("vdelta") != null)
			{
				document.getElementById("vdelta").remove();
			}
			
			var svgPDD = document.getElementById("svgPDD");
			svgPDD.innerHTML += `<line id="vdelta" x1="70" y1="150" x2="70" y2="${150+(vdelta*4)}" style="stroke:yellow;stroke-width:2;" />`;
			
		}
		
		
        function getpos()
        {            
            if (navigator.geolocation) 
            {
                navigator.geolocation.watchPosition(showPosition, errorPosition, { maximumAge: 3000, timeout: 5000, enableHighAccuracy: true });
            } 
            else 
            {
                testout.innerHTML = "Geolocation is not supported by this browser.";
            }
        }
        
        function showPosition(position) 
        {
            datacnt += 1;
            
            var _lat = position.coords.latitude;
            var _lon = position.coords.longitude;
            
            alt = position.coords.altitude;
            hdg = position.coords.heading;
            var _spd = spd;
			spd = position.coords.speed * 3.6;
			if (_spd && spd)
			{
				vdelta = _spd - spd;
			}
			else
			{
				vdelta = 0;
			}
				
            acc = position.coords.accuracy;
            
            if (!lat)
            { lat = _lat; lon = _lon; }
            
            var _dst = getDistanceFromLatLonInKm(lat,lon,_lat,_lon);
                    
            if (_dst >= acc / 1000.0)
            {                
                dst += _dst;
                lat = _lat;
                lon = _lon;
            }
            
            display();
        }

        function display()
        {   
			setSpeedTabCurrV(Math.trunc(spd), vdelta * 10);
			setAltTabCurrV(Math.trunc(alt));
			setDstCurrV(Math.trunc(dst * 1000)/1000);
			setHdgCurrV(Math.trunc(hdg));
        }
        
        function showvalue(value, unit, decimals) {
            var out;
            if (value)
            { out = `<div style="width:50%;border:1px solid gray;margin:auto;margin-bottom:5px;padding:5px;border-radius:5px;text-align:center;font-size:2em;background:gray;color:lime;">${Math.trunc(value*decimals)/decimals} ${unit}</div>`; }
            else
            { out = `<div style="width:50%;border:1px solid gray;margin:auto;margin-bottom:5px;padding:5px;border-radius:5px;text-align:center;font-size:2em;background:gray;color:red;"> XXXX ${unit}</div>`; }
            return out;			
			
        }
        
        function errorPosition()
        {
            document.getElementById("currpostest").innerHTML = "No Data!";
            
            document.getElementById("spdlimits").innerHTML = "No Data!";
            
            document.getElementById("curr").innerHTML = "No Data!";
        }
        
        function showHideBox()
        {
            this.parentElement.nextElementSibling.classList.toggle("hidden");
            if (this.parentElement.nextElementSibling.classList.contains("hidden"))
            {
                this.children[0].classList.replace("hideimg", "showimg");
            }
            else
            {
                this.children[0].classList.replace("showimg", "hideimg");
            }
        }
        
        /* from: https://stackoverflow.com/questions/27928/calculate-distance-between-two-latitude-longitude-points-haversine-formula */
        function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) 
        {
          var R = 6371; // Radius of the earth in km
          var dLat = deg2rad(lat2-lat1);  // deg2rad below
          var dLon = deg2rad(lon2-lon1); 
          var a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2)
            ; 
          var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
          var d = R * c; // Distance in km
          return d;
        }

        function deg2rad(deg) {
          return deg * (Math.PI/180)
        }
    </script>
</body>
</html>