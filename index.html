<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <title id="title1">IDisVX</title>
	<style>
		* 
		{
			font-family:sans-serif;
			font-size: 14px;		
		}
		
		body
		{
			background: black;
		}
	</style>
    <audio src="apoff.wav" id="apoffsnd"></audio>
    <audio src="retard.wav" id="retardsnd"></audio>
</head>
<body>

	<div id="pdd"></div>
    <div id="rteimpbox" class="impbox" style="color:magenta;">
	   RTE: <input type="file" name="files[]" id="fileimp"/>		
    </div>
    
    <script>	
	    var sound = false;
        var sndretard;
        var sndapdisc;
        
        var vpw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
        var vph = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
        
        var test = false;
        
        var speedtabzoomfactor = 6;
        
        var h = 420;
        var ht = (300 * 1.2) * vph / vpw;
        var upperrow = 40;
        var rose = 130;
        var rosepos = h/2;
        
        var lat = 0;
        var lon = 0;
        var alt = 0;
        var hdg = 0;
        var spd = 0;
		var vdelta = 0;
        var acc = 999;
        var dst = parseInt(localStorage.getItem("idis_total_dist"));
        
        console.log(localStorage.getItem("idis_wplat"));
        
        var wplat = [];
        var wplon = [];
        var rtename = "test";
        
        var str_wplat = localStorage.getItem("idis_wplat");
        var str_wplon = localStorage.getItem("idis_wplon");
        var str_rtename = localStorage.getItem("idis_rtename");
        
        if (str_wplat)
        {
            wplat = str_wplat.split(",");
            wplon = str_wplon.split(",");
            rtename = str_rtename;            
        }

        
        if (!dst) {dst = 0;}        
        
        var datacnt = 0;
        
        var currSpdTabVal = 0;
        var currSpdTabValStep = 0.0;
        
        var currAltTabVal = 0;
        var currAltTabValStep = 0.0;
        
        var markerV = [ 15, 25, 38, 45, 55 ];
        var markerID = [ "2", "3", "4", "5", "6" ];

        var maxSpeed = 183;
        var idealSpeed = 130;
        
        var spdlmts = [ 30, 50, 60, 70, 80, 100, 120, -1 ];
        var currSpdLimit = 1000;
        var tolerancespdlmt = 5;
        
        document.getElementById("fileimp").addEventListener("change", importRte, false);
        
		drawPDD("pdd");
		
        if (test)
        {
            setInterval(function() { spd = (Math.random() * 25 + 50); }, 5000);
            setInterval(function() { hdg = (Math.random() * 25 + 90); }, 5000);
            setInterval(function() { alt = Math.random() * 1000; }, 5000);
        }
        
        getpos();
        
		function drawPDD(targetID)
		{   
			var frame = document.getElementById(targetID);
			frame.style.background = "black";
			frame.innerHTML = `<svg width="90vw" height="120vh" viewbox="0 0 300 ${ht}" id="svgPDD" style="margin:10px;"></svg>`;
			var svgPDD = document.getElementById("svgPDD");
            svgPDD.innerHTML += genRoseObj();
			svgPDD.innerHTML += `<rect x="0" y="${upperrow}" width="80" height="${h}" style="stroke:none;fill:dimgray" />"`;
			svgPDD.innerHTML += `<line x1="0" y1="${upperrow}" x2="100" y2="${upperrow}" style="stroke:white;stroke-width:2" />`;
			svgPDD.innerHTML += `<line x1="0" y1="${h-1}" x2="100" y2="${h-1}" style="stroke:white;stroke-width:2" />`;			
			svgPDD.innerHTML += `<line x1="80" y1="${upperrow}" x2="80" y2="${h}" style="stroke:white;stroke-width:2" />`;			
			svgPDD.innerHTML += genSpeedTabObj();
			svgPDD.innerHTML += `<line x1="0" y1="${h/2}" x2="90" y2="${h/2}" style="stroke:yellow;stroke-width:2" />`;
			svgPDD.innerHTML += `<polyline points="85,${h/2} 95,${h/2-5} 95,${h/2+5}" style="stroke:none;fill:yellow" />`;
			
			svgPDD.innerHTML += `<rect x="220" y="${upperrow}" width="80" height="${h}" style="stroke:none;fill:dimgray" />"`;
			svgPDD.innerHTML += `<line x1="300" y1="${upperrow}" x2="200" y2="${upperrow}" style="stroke:white;stroke-width:2" />`;
			svgPDD.innerHTML += `<line x1="300" y1="${h-1}" x2="200" y2="${h-1}" style="stroke:white;stroke-width:2" />`;			
			svgPDD.innerHTML += `<line x1="220" y1="${upperrow}" x2="220" y2="${h}" style="stroke:white;stroke-width:2" />`;			
			svgPDD.innerHTML += genAltTabObj();			
			svgPDD.innerHTML += `<rect x="220" y="0" width="80" height="${upperrow-1}" style="stroke:none;fill:black" />`;			
			svgPDD.innerHTML += `<rect x="220" y="-200" width="80" height="${199+upperrow}" style="stroke:none;fill:black" />`;		
			svgPDD.innerHTML += `<rect x="220" y="${h/2-upperrow/2}" width="80" height="${upperrow}" style="stroke:yellow;fill:black;stroke-width:2" />`;		
			svgPDD.innerHTML += `<text x="235" y="${h/2+6}" style="fill:lime;font-size:1.5em" id="valAltTab">XXXX</text>`;		
			svgPDD.innerHTML += `<rect x="0" y="${h}" width="500" height="${599+upperrow}" style="stroke:none;fill:black" />`;	
			
            svgPDD.innerHTML += `<rect x="0" y="-200" width="300" height="${199+upperrow}" style="stroke:none;fill:black" />`;
            
			svgPDD.innerHTML += `<rect x="0" y="0" width="80" height="${upperrow-5}" style="stroke:white;fill:black" />`;			
			svgPDD.innerHTML += `<text x="5" y="${upperrow-10}" style="fill:lime;font-size:2em;" id="valSpdTab">XXX</text>`;			
			svgPDD.innerHTML += `<rect x="80" y="0" width="140" height="${upperrow-5}" style="stroke:white;fill:black" />`;			
			svgPDD.innerHTML += `<text x="85" y="${upperrow-10}" style="fill:white;font-size:2em;" id="valDst">XXXX.X</text>`;
			svgPDD.innerHTML += `<rect x="220" y="0" width="80" height="${upperrow-5}" style="stroke:white;fill:black" />`;			
			svgPDD.innerHTML += `<text x="225" y="${upperrow-10}" style="fill:red;font-size:2em;" id="valAcc">XXX</text>`;
		      
            for (var i = 0; i < spdlmts.length; i++)
            {
                var _id = "spdlmt" + spdlmts[i];
                var _y = h + upperrow + 5;;
                var _x = 300/spdlmts.length * i;     
                var _caption = spdlmts[i];
                if (_caption == -1)
                {
                    _caption = "opn";
                }
                svgPDD.innerHTML += `<rect x="${_x}" y="${_y-32}" width="${300/spdlmts.length}" height="40" fill="black" stroke="white" onmouseup="selectSpdLimit(${spdlmts[i]})" />`;
                svgPDD.innerHTML += `<text x="${_x+2}" y="${_y+2}" style="fill:gray;font-size:1.3em;" id="${_id}" onmouseup="selectSpdLimit(${spdlmts[i]})">${_caption}</text>`;
            }
            
            showInvalidCross(true);
            
                 
            setSpeedTabCurrV();            
            setAltTabCurrV();
        }
        
        function genRoseObj()
        {
            var _r = rose;
            
            
            
            var outElement = `<g id='rose' transform="translate(150,${rosepos})">`;
            
            outElement += `<circle cx="0" cy="0" r="${_r}" style="stroke:white;stroke-width:2;fill:none;" />`;
            
            outElement += `<circle cx="0" cy="0" r="${100}" style="stroke:white;stroke-width:1;fill:none;" stroke-dasharray="2"/>`;
            outElement += `<circle cx="0" cy="0" r="${75}" style="stroke:white;stroke-width:1;fill:none;" stroke-dasharray="2"/>`;
            outElement += `<circle cx="0" cy="0" r="${50}" style="stroke:white;stroke-width:1;fill:none;" stroke-dasharray="2"/>`;
            outElement += `<circle cx="0" cy="0" r="${25}" style="stroke:white;stroke-width:1;fill:none;" stroke-dasharray="2"/>`;
            
            for (var i = 0; i <= 360; i += 5)
            {
                outElement += `<path d="M0 ${-_r} l0 -4" style="stroke:white;stroke-width:2;fill:none;" transform="rotate(${i})" />`;
            }
            
            for (var i = 0; i <= 350; i += 10)
            {
                outElement += `<path d="M0 ${-_r} l0 -8" style="stroke:white;stroke-width:2;fill:none;" transform="rotate(${i})" />`;
                
                _fsize = "1.5em";
                
                if (i % 3 > 0)
                { _fsize = "0.8em"; }
                
                outElement += `<text x="0" y="${-_r-15}" transform="rotate(${i})" alignment-baseline="middle" text-anchor="middle"><tspan style="fill:white;font-size:${_fsize}">${i/10}</tspan></text>`;
            }
            
            outElement += "</g>";
            
            outElement += `<g id='rosecenter' transform="translate(150,${rosepos})">`;
            
            outElement += `<path d="M-10 0 l 20 0" style="stroke:white;stroke-width:2;fill:none;" />`;
            outElement += `<path d="M0 -10 l 0 20" style="stroke:white;stroke-width:2;fill:none;" />`;
            
            outElement += `<path d="M0 ${-rose+10} l 0 -20" style="stroke:yellow;stroke-width:2;fill:none;" />`;
            
            outElement += "</g>";
            
            return outElement;
        }
        
        function setRoseCurrC()
        {
            setTimeout(function() 
            {
                document.getElementById("rose").setAttribute("transform", `translate(150,${rosepos}) rotate(${0})`);
                                
                if (wplat)
                {
                    
                    if (document.getElementById("route"))
                    {
                        document.getElementById("route").remove();
                    }
                    
                    rosectr = document.getElementById("rose");
                    
                    
                    var rte = "<g id='route'><path d='";
                    
                    var _c = "M";
                    
                    for (var i= 0; i < wplat.length; i++)
                    {   
                        var rtex = getDistanceFromLatLonInKm(0,lon,0,wplon[i])*100;
                        var rtey = getDistanceFromLatLonInKm(lat,0,wplat[i],0)*100;
                        
                        if(lon > wplon[i])
                        { rtex = -rtex;}
                        
                        if(lat < wplat[i])
                        { rtey = -rtey; }                        
                        
                        if (Math.sqrt(rtex*rtex+rtey*rtey) < rose * 1.3)
                        {                            
                            rte += `${_c} ${rtex} ${rtey} `;                        
                            _c = "L";
                        }
                        
                        
                        
                        /*rte += `<circle cx="${rtex}" cy="${rtey}" r="2" stroke="white" fill="none"/>`;                      */
                    }
                    
                    rte += "' stroke='lime' fill='none' />";
                    rte += `<text x="0" y="${rose + 60}" alignment-baseline="middle" text-anchor="middle"><tspan style="fill:yellow;font-size:0.8em">${rtename}</tspan></text>`;
                    rte += "</g>";
                    
                    rosectr.innerHTML += rte;
                }  
                
                if (hdg) 
                {
                    document.getElementById("rose").setAttribute("transform", `translate(150,${rosepos}) rotate(${-hdg})`);
                    
                    if (document.getElementById("invalidCrossRose"))
                    { document.getElementById("invalidCrossRose").remove(); }
                }
                else
                {   
                    rosectr = document.getElementById("rosecenter");

                    rosectr.innerHTML += `<g id="invalidCrossRose" transform="translate(0,${-rose})"><line x1="-20" y1="-20" x2="20" y2="20" style="stroke:red;stroke-width:4;" /><line x1="-20" y1="20" x2="20" y2="-20" style="stroke:red;stroke-width:4;" /></g>`;
                }
                
                setRoseCurrC();
            }, 1000);
        }
        
        function selectSpdLimit(v)
        {   
            if (!sound)
            {
                sndapdisc = document.getElementById("apoffsnd");
                sndretard = document.getElementById("retardsnd");
                sound = true;   
                sndapdisc.play();
                sndretard.play();
            }
            
            for (var i = 0; i < spdlmts.length; i++)
            {
                var _id = "spdlmt" + spdlmts[i];
                document.getElementById(_id).style.fill = "gray";
            }
            
            currSpdLimit = v;
            if (currSpdLimit == -1)
            { 
                currSpdLimit = 1000;
                if (sound)
                {
                    sndapdisc.play();
                }
            
            }
            
            document.getElementById("spdlmt" + v).style.fill = "magenta";
        }
		
		function setAccCurrV(a)
		{
            var svgPDD = document.getElementById("svgPDD");
            
            if (document.getElementById("valAcc"))
            { document.getElementById("valAcc").remove();}
            
            var color = "red";
            
            if (a < 11)
            { color = "orange"; }
            
            if (a < 6)
            { color = "lime"; }
            
            if (a > 10)
            {
                showInvalidCross(true);       
            }
            else
            {
                showInvalidCross(false);       
            }
            
            svgPDD.innerHTML += `<text x="225" y="${upperrow-10}" style="fill:${color};font-size:2em;" id="valAcc">${a}</text>`;
		}
		
		function setDstCurrV(a)
		{
			document.getElementById("valDst").innerHTML = a + "";		
		}
		
		function genAltTabObj()
		{
			var outElement = "<g id='altTab'>";
			var a;
            
            /*for (a = -1000; a <= 15000; a += 10)
			{
				y = h+upperrow-a;
				outElement += `<line x1="225" y1="${y}" x2="220" y2="${y}" style='stroke:white;stroke-width:1;'/>`;
			}*/
            
            for (a = 0; a > -250; a -= 16)
			{
				y = h-a;
				outElement += `<line x1="220" y1="${y+16}" x2="300" y2="${y}" style='stroke:orange;stroke-width:2;'/>`;				
			}
            
			for (a = -1000; a <= 15000; a += 50)
			{
				y = h-a;
				outElement += `<line x1="230" y1="${y}" x2="220" y2="${y}" style='stroke:white;stroke-width:2;'/>`;
				outElement += `<text x="240" y="${y+5}" style="fill:white;font-size:1.5em;">${a}</text>`;
			}
			outElement += "</g>";
			
			return outElement;
		}
		
		function setAltTabCurrV()
		{
            setTimeout(function() {
                currAltTabValStep = (alt - currAltTabVal) / 3;
                currAltTabVal += currAltTabValStep;
                var _v = Math.trunc(currAltTabVal);
                document.getElementById("valAltTab").innerHTML = _v;
                _v -= h/2;
                document.getElementById("altTab").setAttribute("transform", `translate(0,${_v})`);			
                
                setAltTabCurrV();
            }, 100);
		}
		
		function genSpeedTabObj()
		{
			var outElement = "<g id='spdTab'>";
			var y;
            
            for (v = 0; v > -100; v -= 4)
			{
				y = h-speedtabzoomfactor*v;
				outElement += `<line x1="0" y1="${y+16}" x2="80" y2="${y}" style='stroke:orange;stroke-width:2;'/>`;				
			}
            
            for (v = 0; v <= 1250; v += 5)
			{
				y = h-speedtabzoomfactor*v;
				outElement += `<line x1="70" y1="${y}" x2="80" y2="${y}" style='stroke:white;stroke-width:1;'/>`;				
			}
            
			for (v = 0; v <= 1250; v += 10)
			{
				y = h-speedtabzoomfactor*v;
				outElement += `<line x1="70" y1="${y}" x2="80" y2="${y}" style='stroke:white;stroke-width:2;'/>`;
				outElement += `<text x="20" y="${y+7}" style="fill:white;font-size:2em;">${v}</text>`;
			}
			
			for (var i = 0; i < markerV.length; i++)
			{
				y = h-speedtabzoomfactor*markerV[i];
				outElement += `<line x1="70" y1="${y}" x2="85" y2="${y}" style='stroke:lime;stroke-width:2;'/>`;
				outElement += `<text x="87" y="${y+5}" fill="lime">${markerID[i]}</text>`;
			}
			
			var absLowLimit = 7;
			y = h - speedtabzoomfactor * absLowLimit; 
			outElement += `<line x1="84" y1="${h}" x2="84" y2="${y}" style="stroke:orange;stroke-width:4;"/>`;
            
            y = h - speedtabzoomfactor * 0; 
			outElement += `<line x1="84" y1="${h*2}" x2="84" y2="${y}" style="stroke:red;stroke-width:8;" stroke-dasharray="8"/>`;
            outElement += `<line x1="88" y1="${h*2}" x2="88" y2="${y}" style="stroke:red;stroke-width:2;"/>`;
            y = h - speedtabzoomfactor * maxSpeed;
            outElement += `<line x1="65" y1="${y}" x2="75" y2="${y}" style="stroke:orange;stroke-width:2;" />`;
            outElement += `<line x1="65" y1="${y-4}" x2="75" y2="${y-4}" style="stroke:orange;stroke-width:2;" />`;
            
            y = h - speedtabzoomfactor * idealSpeed;
            outElement += `<circle cx="80" cy="${y}" r="6" style="stroke:lime;stroke-width:4;fill:none" />`;
            
			outElement += "</g>";
			
			return outElement;
		}
        
		function setSpeedTabCurrV()
		{            
            setTimeout(function() {		    
                var _d = vdelta * 5;             
                
                currSpdTabValStep = (spd - currSpdTabVal) / 3.0;
                
                if (currSpdTabValStep >= 3.0)
                { 
                    currSpdTabValStep = 3.0;                     
                }     
                else if (currSpdTabValStep <= -3.0)
                { 
                    currSpdTabValStep = -3.0; 
                }
                
                currSpdTabVal += currSpdTabValStep;
                var _v = Math.trunc(currSpdTabVal);                
                _v = _v * speedtabzoomfactor;
                _v -= h/2;
                document.getElementById("spdTab").setAttribute("transform", `translate(0,${_v})`);
                
                if (document.getElementById("vdelta"))
                { document.getElementById("vdelta").remove(); }
                var svgPDD = document.getElementById("svgPDD");
                svgPDD.innerHTML += `<line id="vdelta" x1="70" y1="${h/2}" x2="70" y2="${h/2+(_d*speedtabzoomfactor)}" style="stroke:yellow;stroke-width:4;" />`;
                /*svgPDD.innerHTML += `<path d="M70 ${h/2+(_d*speedtabzoomfactor)} l-5 0 l5 -10 l5 10 l-5 10 l-5 -10" style="stroke:none;fill:yellow;"/>`;*/
                
                var y1 = h - speedtabzoomfactor * currSpdLimit; 
                var y2 = h - speedtabzoomfactor * (currSpdLimit + tolerancespdlmt);  
                var y3 = h - speedtabzoomfactor * (currSpdLimit + 2 * tolerancespdlmt);            
                var _color = "red";
                if (currSpdTabVal < currSpdLimit + 2 * tolerancespdlmt) { _color = "orange"; }
                if (currSpdTabVal < currSpdLimit + tolerancespdlmt) { _color = "lime"; }
                
                if (document.getElementById("valSpdTab"))
                { document.getElementById("valSpdTab").remove(); }
                
                svgPDD.innerHTML += `<text x="5" y="${upperrow-10}" style="fill:${_color};font-size:2em;" id="valSpdTab">${Math.trunc(spd)}</text>`;
                
                if (document.getElementById("spdlimit"))
                { document.getElementById("spdlimit").remove(); }            
                var outElement;
                
                outElement += `<g id="spdlimit">`;
                outElement += `<line id="spdlimit1" x1="84" y1="${y2}" x2="84" y2="${y3}" style="stroke:orange;stroke-width:4;"/>`;
                outElement += `<line id="spdlimit2" x1="84" y1="${y-1000}" x2="84" y2="${y3}" style="stroke:red;stroke-width:8;" stroke-dasharray="8"/>`;    
                outElement += `<line id="spdlimit2" x1="88" y1="${y-1000}" x2="88" y2="${y3}" style="stroke:red;stroke-width:2;" />`; 
                outElement += `<polyline id="spdlimit3" points="85,${y1} 100,${y1-8} 100,${y1+8} 85,${y1}" style="stroke:magenta;fill:none;stroke-width:2;" />`;
                outElement += `</g>`;
                
                document.getElementById("spdTab").innerHTML += outElement;
                
                setSpeedTabCurrV();
                
            }, 30);
		}
        
        function showInvalidCross(v)
        {
            if (v)
            {
                var svgPDD = document.getElementById("svgPDD");
                
                svgPDD.innerHTML += `<g id="invalidCross"><line x1="0" y1="${h/2-40}" x2="80" y2="${h/2+40}" style="stroke:red;stroke-width:4;" /><line x1="0" y1="${h/2+40}" x2="80" y2="${h/2-40}" style="stroke:red;stroke-width:4;" /></g>`
            }
            else
            {
                if (document.getElementById("invalidCross"))
                { document.getElementById("invalidCross").remove(); }
            }            
        }
		
		
        function getpos()
        {            
            if (navigator.geolocation) 
            {
                navigator.geolocation.watchPosition(showPosition, errorPosition, { maximumAge: 3000, timeout: 5000, enableHighAccuracy: true });
            } 
            else 
            {
                testout.innerHTML = "Geolocation is not supported by this browser.";
            }
        }
        
        function showPosition(position) 
        {
            datacnt += 1;
            
            var _lat = position.coords.latitude;
            var _lon = position.coords.longitude;
            
            alt = position.coords.altitude;
            hdg = position.coords.heading;
            var _spd = spd;
			spd = position.coords.speed * 3.6;            
            
			if (_spd && spd)
			{
				vdelta = _spd - spd;
			}
			else
			{
				vdelta = 0;
			}
		    
            if(!spd)
		    { spd = 0; }
            
            if(!hdg)
		    { hdg = 0; }
            if(!alt)
		    { alt = 0; }            
				
            acc = position.coords.accuracy;
            
            if (!lat)
            { lat = _lat; lon = _lon; }
            
            var _dst = getDistanceFromLatLonInKm(lat,lon,_lat,_lon);
                    
            if (_dst >= acc / 1000.0)
            {                
                dst += _dst;
                localStorage.setItem("idis_total_dist", dst)
                lat = _lat;
                lon = _lon;
            }
            
            if (currSpdTabVal > currSpdLimit + 20)
            { 
                selectSpdLimit(-1);                 
            }
            
            if (spd >= currSpdLimit + tolerancespdlmt * 2)
            {
                if (sound)
                {                    
                    sndretard.play();        
                }
            }
            
            display();
        }
        function display()
        {   
            showInvalidCross(false);
			setDstCurrV(Math.trunc(dst * 10)/10);
			setAccCurrV(Math.trunc(acc));
            setRoseCurrC(Math.trunc(hdg));
        }
        
        function errorPosition()
        {
            setAccCurrV(Math.trunc(999));            
            showInvalidCross(true);
        }
        
        function showHideBox()
        {
            this.parentElement.nextElementSibling.classList.toggle("hidden");
            if (this.parentElement.nextElementSibling.classList.contains("hidden"))
            {
                this.children[0].classList.replace("hideimg", "showimg");
            }
            else
            {
                this.children[0].classList.replace("showimg", "hideimg");
            }
        }
        
        function importRte(e) 
        {	
            var file = e.target.files[0];

            if (!file) 
            {
                return;
            }

            filename = file.name;

            var reader = new FileReader();
            reader.onload = function() 
            {
                var str = reader.result;
                interpretRte(str);
            };

            localStorage.setItem("idis_rtename", filename);
            
            reader.readAsText(file);  
        }
        
        function interpretRte(rtesrc)
        {	
            var parser = new DOMParser();
            var xmlDoc = parser.parseFromString(rtesrc, "text/xml");
                        
            for (var i = 0; i < xmlDoc.getElementsByTagName("trkpt").length; i++)
	        {
                wplat.push(xmlDoc.getElementsByTagName("trkpt")[i].getAttribute("lat"));
                wplon.push(xmlDoc.getElementsByTagName("trkpt")[i].getAttribute("lon"));
            
            }
            
            localStorage.setItem("idis_wplat", wplat);
            localStorage.setItem("idis_wplon", wplon);
            
            location.reload();
        }
        
        /* from: https://stackoverflow.com/questions/27928/calculate-distance-between-two-latitude-longitude-points-haversine-formula */
        function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) 
        {
          var R = 6371; // Radius of the earth in km
          var dLat = deg2rad(lat2-lat1);  // deg2rad below
          var dLon = deg2rad(lon2-lon1); 
          var a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2)
            ; 
          var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
          var d = R * c; // Distance in km
          return d;
        }
        function deg2rad(deg) {
          return deg * (Math.PI/180)
        }
    </script>
</body>
</html>
